<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Jolokia plot demo</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.js" integrity="sha256-t7kx8nPDixJ3ucbB9OBcTsCYhaSHvdrzJ54tfkmjjhI=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.time.js" integrity="sha256-pYLIMq3HE4prBar2HxbrrCdHAfG+Sv6nfnOaHDS5xBo=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20160511/json2.js" integrity="sha256-EZJ68U7eUi8uSP0MRRUalYten2eOlhREE9kJOIbIeYg=" crossorigin="anonymous"></script>
  
  <script src="js/jolokia-min.js"></script>
  <script src="js/jolokia-simple-min.js"></script>
</head>
<html>
<h1>[Jolokia Web Viewer]</h1>

<input type="text" id="endpoint" size="50" value="https://your-gateway/actuator/jolokia"/>
<input type="submit" id="start" value="Start"/>

<hr>
<h2>Memory Usage</h2>

<div id="plotMemory" style="width: 100%; height:400px; margin-top: 20px;"></div>
<input type="submit" id="gc" value="Garbage Collection" disabled="true">
<br><br>

<hr>
<div style="width: 100%; text-align: center"><a href="https://github.com/gmpassos/jolokia-web-viewer" target="_blank">jolokia-web-viewer@GitHub</a></div>

<script id="source" language="javascript" type="text/javascript">

  let j4p ;

  function start() {
    var inputEndpoint = $("#endpoint") ;
    var endpoint = inputEndpoint.val() ;

    console.log("Endpoint: "+ endpoint);

    j4p = new Jolokia({url: endpoint,jsonp: true});

    inputEndpoint.prop('disabled', true);
    $("#start").prop('disabled', true);
    $("#gc").prop('disabled', false);

    run();
  }

  let datasetMemMax = [];
  let datasetMemUsed = [];

  function doPlot() {
    $.plot("#plotMemory", [
      { data: datasetMemMax, label: "Max Memory" },
      { data: datasetMemUsed, label: "Used Memory"}
    ], {
      series: {
        lines: {lineWidth: 2}
      },
      xaxes: [ { mode: "time"} ],
    });
  }


  function run() {
    j4p.request({
                  type: "read",
                  mbean: "java.lang:type=Memory",
                  attribute: "HeapMemoryUsage"
                },
                {
                  success: function(resp) {
                    let memMax = resp.value.max / (1024 * 1024);
                    let memUsed = resp.value.used / (1024 * 1024);
                    let time = resp.timestamp * 1000;

                    datasetMemMax.push([time, memMax]);
                    datasetMemUsed.push([time, memUsed]);

                    doPlot();

                    setTimeout(run,2000);
                  }
                });
  }

  $("#start").click(start);

  $("#gc").click(function() {
    j4p.execute("java.lang:type=Memory","gc", {
          success: function() {
              console.log("Garbage collection performed");
          }
     });
  });
  
</script>
</body>
</html>